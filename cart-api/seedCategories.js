// seedCategories.js
require("dotenv").config();
const mongoose = require("mongoose");
const Category = require("./src/models/Category");

// 🗂️ מבנה הקטגוריות – 3 שכבות (ראשית → משנית → תת־משנה)
const categories = [
  {
    name: "מעדניית נקניקים",
    subs: [
      { name: "פסטרמות", children: ["פסטרמות הודו / עוף / אווז", "פסטרמות לבנה", "פסטרמות בקר", "פסטרמות ארוזות"] },
      { name: "נקניקים", children: ["נקניק חצי יבש", "נקניק Raw חי", "נקניק מבושל", "קבנוס", "נקניקים ארוזים"] },
      { name: "נקניקיות", children: ["נקניקיות במשקל", "נקניקיות ארוזות"] }
    ]
  },
  {
    name: "מעדניית גבינות ודגים",
    subs: [
      { name: "גבינות במשקל", children: ["גבינות קשות / חצי קשות / מיוחדות", "גבינות עזים / מיוחדות", "גבינות מלוחות", "גבינות לבנות"] },
      { name: "דגים מעושנים / מלוחים / מיובשים", children: ["דגים מעושנים/כבושים", "דגים מלוחים", "דגים מיובשים", "קוויאר"] },
      { name: "תחליפי גבינה", children: ["תחליפי גבינה"] }
    ]
  },
  {
    name: "קצבייה",
    subs: [
      { name: "עוף והודו טרי", children: ["עוף טרי וחלקיו", "הודו טרי וחלקיו"] },
      { name: "בשרים", children: ["בשר עגל / בקר טרי", "בשר כבש / טלה טרי", "בשר לבן טרי"] },
      { name: "כשרת קצבים", children: ["כשרת קצבים על הראש", "עופות ארוזים"] }
    ]
  },
  {
    name: "פירות ירקות ופיצוחים",
    subs: [
      { name: "ירקות טריים", children: ["ירקות", "פטריות ונבטים", "עלי תיבול"] },
      { name: "פירות טריים", children: ["פירות"] },
      { name: "פירות יבשים ופיצוחים", children: ["פירות יבשים", "אגוזים ופיצוחים"] }
    ]
  },
  {
    name: "יין בירה ואלכוהול",
    subs: [
      { name: "יינות", children: ["יין אדום", "יין לבן", "יין מבעבע", "יין רוזה", "תירוש"] },
      { name: "אלכוהול", children: ["וודקה", "וויסקי", "ברנדי וקוניאק", "רום וג׳ין", "ליקרים", "טקילה", "ערק ואניס", "משקאות קלים"] },
      { name: "בירות", children: ["בירה בבקבוק", "בירה במארז", "בירה בחבית", "בירה שחורה/קוואס", "בירות ללא אלכוהול"] },
      { name: "משקאות אנרגיה", children: ["משקאות אנרגיה"] },
      { name: "סיגריות", children: ["סיגריות באריזה בודדת"] }
    ]
  },
  {
    name: "לחמים עוגות ועוגיות",
    subs: [
      { name: "לחמים", children: ["לחמים ארוזים", "חלה", "טורטיה", "לחמניות ופיתות"] },
      { name: "עוגות ועוגיות", children: ["עוגות ארוזות", "עוגות כשרות לפסח", "עוגות דז׳ו", "עוגות תחאיה", "עוגיות וביסקוויטים", "עוגות קפואות"] },
      { name: "מאפים", children: ["מאפי קיטו", "קרקרים", "פריכיות"] }
    ]
  },
  {
    name: "מתוקים וחטיפים",
    subs: [
      { name: "ממתקים", children: ["טבלאות שוקולד", "חטיפי שוקולד", "מארזים משפחתיים", "סוכריות", "בונבוניירות", "מסטיקים", "תמרים/דבלים", "מארזי חג"] },
      { name: "חטיפים", children: ["חטיפים מלוחים", "פיצוחים", "אגוזים", "גרעינים", "בייגלה", "פופקורן"] }
    ]
  },
  {
    name: "בריאות ואורגני",
    subs: [
      { name: "אורגני", children: ["פסטות אורגניות", "ממרחים", "רטבים", "שימורים", "דגני בוקר אורגניים", "תחליפי חלב אורגניים", "משקאות אורגניים", "מילדות אורגניות"] },
      { name: "ללא גלוטן", children: ["לחמים", "קרקרים", "פסטות", "קמחים", "חטיפים", "עוגיות", "דגנים"] },
      { name: "דיאט וללא סוכר", children: ["תחליפי סוכר", "ממתקים ללא סוכר", "עוגיות ללא סוכר", "משקאות דיאט", "שוקולדים ללא סוכר"] },
      { name: "מן הצומח", children: ["תחליפי חלב צמחיים", "מעדנים טבעוניים", "תחליפי בשר טבעוני"] }
    ]
  },
  {
    name: "מוצרי יסוד ומכולת",
    subs: [
      { name: "מוצרי יסוד", children: ["שמנים", "קמחים", "סוכר", "מלח", "תבלינים"] },
      { name: "רטבים", children: ["קטשופ", "מיונז", "חרדל", "טחינה", "רטבים לסלט", "חומץ"] },
      { name: "שימורים", children: ["ירקות משומרים", "פירות משומרים", "דגים משומרים", "בשר משומר"] },
      { name: "אפייה", children: ["קקאו", "שוקולד לאפייה", "שמרים", "קצפת"] },
      { name: "בישול", children: ["קטניות", "פסטות", "אורז", "קוסקוס", "מרקים"] },
      { name: "דבש וריבות", children: ["דבש", "ריבות", "חלוה"] }
    ]
  },
  {
    name: "דגים ופירות ים",
    subs: [
      { name: "דגים טריים", children: ["דגים טריים"] },
      { name: "פירות ים", children: ["פירות ים קפואים"] },
      { name: "דגים קפואים", children: ["דגים קפואים"] },
      { name: "דגים מעושנים", children: ["דגים מעושנים"] },
      { name: "קוויאר", children: ["קוויאר"] },
      { name: "דגים ארוזים", children: ["דגים ארוזים"] }
    ]
  },
  {
    name: "קפואים",
    subs: [
      { name: "בצקים", children: ["פיצות", "בורקס", "כיסונים", "גיוזה", "פילאס", "בלינצ'ס", "פנקייק", "מואזי", "בצק לאפיה"] },
      { name: "פירות וירקות קפואים", children: ["ירקות קפואים", "תערובות ירקות", "פירות קפואים"] },
      { name: "בשרים ודגים קפואים", children: ["עוף קפוא", "בשר קפוא", "דגים קפואים"] },
      { name: "גלידה", children: ["גלידות", "מאגדות גלידה", "קרחונים"] },
      { name: "עוגות קפואות", children: ["עוגות קפואות", "מאפים קפואים"] }
    ]
  },
  {
    name: "מוצרי חלב ביצים וסלטים",
    subs: [
      { name: "חלב ומשקאות חלב", children: ["חלב", "משקאות חלב"] },
      { name: "גבינות וחמאות", children: ["גבינות לבנות", "גבינות צהובות", "גבינות שמנת", "גבינות מלוחות", "גבינות עיזים"] },
      { name: "יוגורט ומעדנים", children: ["יוגורט לבן", "יוגורט עם תוספות", "יוגורט בטעמים", "יוגורט סויה", "מעדנים"] },
      { name: "עוגות וקינוחים", children: ["עוגות בקירור", "קינוחים בקירור"] },
      { name: "סלטים", children: ["חומוס", "טחינה", "סלטים מוכנים"] },
      { name: "תחליפי חלב", children: ["תחליפי חלב", "תחליפי יוגורט", "תחליפי גבינה"] },
      { name: "ביצים", children: ["ביצים"] }
    ]
  },
  {
    name: "משקאות",
    subs: [
      { name: "משקאות קלים", children: ["מים מינרליים", "משקאות מוגזים", "מיצים", "תה קר", "קפה קר", "משקאות דיאט", "משקאות אנרגיה"] },
      { name: "משקאות חמים", children: ["קפה נמס", "תה", "קפה שחור", "קפסולות", "תחליפי קפה"] }
    ]
  },
  {
    name: "פארם ותינוקות",
    subs: [
      { name: "היגיינה אישית", children: ["שמפו", "סבון", "סבון מוצק", "מגבונים", "דיאודורנטים"] },
      { name: "היגיינת הפה", children: ["משחות שיניים", "מברשות שיניים", "מי פה"] },
      { name: "מוצרי תינוקות", children: ["חיתולים", "מגבונים לתינוק", "תחליפי חלב לתינוקות"] },
      { name: "פרפומריה", children: ["דאודורנט", "קרמים", "איפור", "בישום"] }
    ]
  },
  {
    name: "חומרי ניקוי",
    subs: [
      { name: "ניקוי לבית", children: ["נוזלי ניקוי", "חומרי חיטוי", "חומרי ניקוי רצפה"] },
      { name: "כביסה וגיהוץ", children: ["אבקות כביסה", "מרכך כביסה"] },
      { name: "אביזרי ניקיון", children: ["סקוטשים", "כפפות", "מטאטאים", "מגבונים"] }
    ]
  },
  {
    name: "לבית ובעלי חיים",
    subs: [
      { name: "בעלי חיים", children: ["מזון לכלבים", "מזון לחתולים", "אביזרים"] },
      { name: "מוצרים לבית", children: ["כלי בית", "נרות", "סוללות"] },
      { name: "חד פעמי", children: ["צלחות חד פעמיות", "סכו״ם חד פעמי", "כוסות חד פעמיות"] },
      { name: "עזרה ראשונה", children: ["תחבושות", "פלסטרים"] }
    ]
  }
];

async function run() {
  try {
    await mongoose.connect(process.env.MONGO_URI);
    console.log("✅ Mongo connected");

    for (const cat of categories) {
      // יצירת קטגוריה ראשית
      const parent = await Category.findOneAndUpdate(
        { name: cat.name, parent: null },
        { $set: { name: cat.name, parent: null } },
        { upsert: true, new: true }
      );

      console.log("📂 Parent:", parent.name);

      for (const sub of cat.subs) {
        const child = await Category.findOneAndUpdate(
          { name: sub.name, parent: parent._id },
          { $set: { name: sub.name, parent: parent._id } },
          { upsert: true, new: true }
        );

        await Category.findByIdAndUpdate(parent._id, {
          $addToSet: { children: child._id }
        });

        console.log("  🔵 Sub:", child.name);

        for (const subsub of sub.children) {
          const subChild = await Category.findOneAndUpdate(
            { name: subsub, parent: child._id },
            { $set: { name: subsub, parent: child._id } },
            { upsert: true, new: true }
          );

          await Category.findByIdAndUpdate(child._id, {
            $addToSet: { children: subChild._id }
          });

          console.log("    🔹 SubSub:", subChild.name);
        }
      }
    }

    console.log("🎉 Categories hierarchy updated successfully!");
    process.exit(0);
  } catch (err) {
    console.error("❌ Error:", err.message);
    process.exit(1);
  }
}

run();
